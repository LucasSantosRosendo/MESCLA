<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/styles/comunidade.css" rel="stylesheet">
    <link href="/styles/media.css" rel="stylesheet">
    <link href="/styles/fonts.css" rel="stylesheet">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src = auth.js></script>
    <script src="comunidade.js" defer></script>
    <title>Comunidade / MESCLA</title>
    <style>
        .active {
            display: block;
        }
        .cubao > div {
            display: none; /* Oculta todas as seções por padrão */
        }
        .cubao > div.active {
            display: block; /* Exibe a seção ativa */
        }
        .botao li a.selected {
            background-color: #3cca94;
            color: #333;
        }
    </style>
        <script src = auth.js></script>
</head>
<body>
    <div class="box"> 
      <li>
        <a href="#" class="botao" onclick="showSection('bairro', this)">
            <i class="fa-solid fa-house"></i> <span>Bairro</span>
        </a>
      </li>
      
      <li>
        <a href="#" class="botao" onclick="showSection('prefeitura', this)">
            <i class="fa-solid fa-landmark"></i> <span>Prefeitura</span>
        </a>
      </li>

      <li>
        <a href="#" class="botao" onclick="showSection('chat', this)">
            <i class="fa-solid fa-message"></i> <span>Chat</span>
        </a>
      </li>

      <li>
        <a href="#" class="botao" onclick="showSection('empresas', this)">
            <i class="fas fa-building"></i> <span>Empresas</span>
        </a>
      </li>
    </div>
    <div class="cubao">
        <div id="bairro" class="active"> <!-- Mantém a seção Bairro visível -->
            <div class="post"><i class="fas fa-person"></i>
                <span>Lucas dos Santos</span>
                <div class="msg">
                    <span>A fiação ta paia hein cemig</span>
                </div>
            </div>
        </div>
        <div id="prefeitura">
            <div class="post"><i class="fas fa-person"></i>
                <span>Prefeitura</span>
                <div class="msg">
                    <span>ATENÇÃO!!!!!!!!!!!!!!!!!!!!!!!!!!!! 
                      <li>
                    <span>obrigado pela atenção</span>
                    </li>
                </div>
            </div>
        </div>
        <div id="chat">
            <div class="post"><i class="fas fa-person"></i>
                <span>Lucas dos Santos</span>
                <div class="msg">
                    <span>A fiação perto do mercadinho deve ser arrumada o quanto antes!</span>
                </div>
            </div>

            <div class="post"><i class="fas fa-person"></i>
              <span>Davi Reis</span>
              <div class="msg">
                  <span>Também acho!</span>
              </div>
          </div>
          <div id="sendMsg">
            <button id="attachBtn" class="attach_btn">
              <i class="fas fa-paperclip"></i>
            </button>
            <input
              type="text"
              id="msgTxt"
              placeholder="Digite sua mensagem..."
            />
            <button id="msgBtn" class="send_btn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
        <div id="empresas">
            <div class="post"><i class="fas fa-person"></i>
                <span>Empresa</span>
                <div class="msg">
                    <span>A fiação ta paia hein cemig</span>
                </div>
            </div>
        </div>
        <div class="card-footer">
          <div class="tooltip">
            <input type="file" id="fileInput" style="display: none" />
            <span class="input-group-text attach_btn">
              <i class="fas fa-paperclip"></i>
            </span>
            <span class="tooltiptext">Enviar arquivo ou imagem</span>
          </div>
        </div>
    </div>
    <script>
        module = {};
      </script>
      <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import {
          getDatabase,
          ref,
          set,
          remove,
          onChildAdded,
          onChildRemoved,
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
  
        const firebaseConfig = {
          apiKey: "AIzaSyCBzItoPtnnZL3qZzaugxDwnzja2g_ddas",
          authDomain: "mescla-f9d00.firebaseapp.com",
          projectId: "mescla-f9d00",
          storageBucket: "mescla-f9d00.appspot.com",
          messagingSenderId: "442057041731",
          appId: "1:442057041731:web:a5d7208555136ba97531f6",
        };
  
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
  
        var msgTxt = document.getElementById("msgTxt");
        var sender;
        if (sessionStorage.getItem("sender")) {
          sender = sessionStorage.getItem("sender");
        } else {
          sender = prompt("Entre com o seu usuário: ");
          sessionStorage.setItem("sender", sender);
        }
  
        module.sendMsg = function sendMsg() {
          var msg = msgTxt.value;
          var timestamp = new Date().getTime();
          set(ref(db, "messages/" + timestamp), {
            msg: msg,
            sender: sender,
          });
  
          msgTxt.value = "";
  
          var companyName = document.getElementById("company_name").textContent;
          ContatosLateral(companyName);
        };
  
        function ContatosLateral(companyName) {
          var contactItem = document.querySelector(
            `.contact-item[data-company="${companyName}"]`
          );
  
          if (contactItem) {
            contactItem.classList.remove("hidden");
  
            let savedContacts =
              JSON.parse(localStorage.getItem("savedContacts")) || [];
            if (!savedContacts.includes(companyName)) {
              savedContacts.push(companyName);
              localStorage.setItem(
                "savedContacts",
                JSON.stringify(savedContacts)
              );
            }
          } else {
            console.log("Empresa não encontrada.");
          }
        }
  
        function restoreContacts() {
          let savedContacts =
            JSON.parse(localStorage.getItem("savedContacts")) || [];
          savedContacts.forEach((companyName) => {
            var contactItem = document.querySelector(
              `.contact-item[data-company="${companyName}"]`
            );
            if (contactItem) {
              contactItem.classList.remove("hidden");
            }
          });
        }
  
        document.addEventListener("DOMContentLoaded", restoreContacts);
  
        onChildAdded(ref(db, "messages"), (data) => {
          let messageClass = data.val().sender === sender ? "me" : "notMe";
          document.getElementById("messages").innerHTML += `
              <div class="outer" id="${data.key}">
                <div id="inner" class="${messageClass}">
                  ${
                    data.val().sender === sender
                      ? "Você: "
                      : data.val().sender + ": "
                  }${data.val().msg}
                  ${
                    data.val().sender === sender
                      ? `<button class="button-delete" onclick="module.dltMsg('${data.key}')">Excluir</button>`
                      : ""
                  }
                </div>
              </div>`;
        });
  
        module.dltMsg = function dltMsg(key) {
          remove(ref(db, "messages/" + key));
        };
  
        onChildRemoved(ref(db, "messages"), (data) => {
          var msgBox = document.getElementById(data.key);
          document.getElementById("messages").removeChild(msgBox);
        });
  
        document
          .getElementById("msgBtn")
          .addEventListener("click", module.sendMsg);
  
        document
          .getElementById("attachBtn")
          .addEventListener("click", function () {
            document.getElementById("fileInput").click();
          });
  
        document
          .getElementById("fileInput")
          .addEventListener("change", function (event) {
            var file = event.target.files[0];
            if (file) {
              console.log("Arquivo selecionado:", file.name);
              //Criar a lógica de como salvar o arquivo ou imagem no database do firebase depois;
            }
          });
      </script>
</body>
</html>